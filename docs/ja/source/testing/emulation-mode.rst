==================================================
エミュレーションモードによるアプリケーションテスト
==================================================

この文書では、エミュレーションモードを利用したアプリケーションのテストについて説明します。

エミュレーションモード
======================

エミュレーションモードを有効にしてAsakusa DSLのテストを実行すると、Asakusa Frameworkが提供するラッパー機構を利用してHadoopの処理を実行します。

エミュレーションモードではテストを実行しているプロセス内でほとんどの処理を行うため、デバッグモードのブレークポイントなどを利用できるようになります。

..  attention::
    本機能はアプリケーションプロジェクトのHadoopライブラリを利用するため、標準で設定されたものと異なるHadoopディストリビューションやバージョンを利用する際に、正しく動かない可能性があります。

..  hint::
    エミュレーションモードを有効にしていない場合、テスト実行時にコマンドラインインターフェースを利用して、別プロセスで様々な処理を行います。
    
    別プロセスで動作させたほうが Java VM 上の問題は起こりにくくなるため、エミュレーションモード利用時に正しく動かない場合には、本機能を無効化して動作を確認してみることを推奨します。

フローDSL/バッチDSLのテスト
---------------------------

エミュレーションモードを有効にして :ref:`データフローのテスト <testing-userguide-dataflow-test>` を行うと、IDEからブレークポイントを指定してデータフロー内の演算子メソッドの動作を確認したり、カバレッジツールと連携して演算子メソッドのテストカバレッジを確認しやすくなります。

インテグレーションテスト
------------------------

:ref:`バッチテストランナー <testing-userguide-integration-test>` とエミュレーションモードを併用すると、インテグレーションテスト時のデバッグ作業がやりやすくなります。

エミュレーションモードの利用方法
================================

エミュレーションモードで利用するモジュール
------------------------------------------

エミュレーションモード用のモジュールはAsakusa FrameworkのMavenリポジトリに以下の内容で登録されています。

..  list-table:: エミュレーションモードで使用するSDKアーティファクト
    :widths: 2 4 5
    :header-rows: 1

    * - グループID
      - アーティファクトID
      - 説明
    * - ``com.asakusafw.sdk``
      - ``asakusa-sdk-test-emulation``
      - テストドライバ実行をエミュレーションモードに変更

..  attention::
    Asakusa Framework バージョン ``0.7.3`` から、エミュレーションに関するモジュール定義は上記のSDKアーティファクトに統一されました。
    
    バージョン ``0.7.2`` 以前で公開されていた以下のモジュール定義も当面は使用できますが、将来のバージョンでは使用できなくなる可能性があるため、上記のSDKアーティファクトに変更することを推奨します。
     
    * ``com.asakusafw:asakusa-test-inprocess``
    * ``com.asakusafw:asakusa-test-inprocess-ext``
    * ``com.asakusafw:asakusa-windgate-test-inprocess``

エミュレーションモードの有効化
------------------------------

アプリケーションプロジェクトでエミュレーションモードを使用する場合は :file:`build.gradle` の ``dependencies`` ブロック内に ``com.asakusafw.sdk:asakusa-sdk-test-emulation`` を利用する依存定義を追加します。

..  code-block:: groovy

    dependencies {
        ...
        testRuntime group: 'com.asakusafw.sdk', name: 'asakusa-sdk-test-emulation', version: asakusafw.asakusafwVersion

..  tip::
    エミュレーションモードを有効する別の方法として、 :jinrikisha:`Shafu<shafu.html>` の機能を使ってEclipse上で設定する方法があります。
    この方法で設定を行うと、Eclipse上でのみエミュレーションモードが有効になります。
    詳しくは :jinrikisha:`Shafu<shafu.html>` の「設定」の説明を参照してください。

Gradle上でのテストドライバ実行
------------------------------

`エミュレーションモードの有効化`_ を行った状態でGradleの :program:`test` タスクを実行すると、テストドライバがエミュレーションモードで実行されます。

..  tip::
    エミュレーションモードを有効にして Gradle上でテストを実行すると、Gradleが提供する `JaCoCo Plugin <http://www.gradle.org/docs/current/userguide/jacoco_plugin.html>`_ などのソースコードカバレッジ取得機能との連携が可能になります。

Eclipse上でのテストドライバ実行
-------------------------------

`エミュレーションモードの有効化`_ を行った状態でGradleの :program:`eclipse` タスクを実行すると、Eclipse上でアプリケーションプロジェクトに対してエミュレーションモードが有効になります。

この状態でEclipseからテストドライバを利用するテストクラスやバッチテストランナーを実行すると、テストドライバがエミュレーションモードで実行されます。

..  tip::
    エミュレーションモードを有効にすると、テストドライバを使ったテストクラスのデバッグ実行時にEclipseのブレークポイント機能などを利用できます。

実行モードの選択
----------------

..  attention::
    通常の場合、ここで説明する設定は不要です。
    旧バージョンからのマイグレーション後にエミュレーションモードが正常に動作しない場合にのみ、ここで説明する設定を有効にして動作を確認してください。

標準の設定では、 ``com.asakusafw.sdk:asakusa-sdk-test-emulation`` を指定したエミュレーションモードの実行時にはスモールジョブ実行エンジンが使用されます。

エミュレーションモードをスモールジョブ実行エンジンを使用しない設定で実行するには、テストドライバ実行時に以下のシステムプロパティを設定します。

``asakusa.testdriver.configurator.inprocess.optimize``
  * ``true``: エミュレーションモードでスモールジョブ実行エンジンを使用する(デフォルト)
  * ``false``: エミュレーションモードでスモールジョブ実行エンジンを使用しない

..  attention::
    Asakusa Framework バージョン ``0.7.2`` 以前では ``com.asakusafw:asakusa-test-inprocess`` を指定したエミュレーションモードの実行にはスモールジョブ実行エンジンは使用されませんでしたが、バージョン ``0.7.3`` からはスモールジョブ実行エンジンを使用するよう変更されました。

..  seealso::
    スモールジョブ実行エンジンについては、 :doc:`../administration/configure-task-optimization` を参照してください。

